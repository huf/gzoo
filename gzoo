#!/usr/bin/env perl
use strict;
use warnings;

use Fcntl;

for my $arg (@ARGV) {
	if ($arg =~ /\.gz\z/ && -f $arg) {
		$arg = turn_me_fifo($arg);
	}
}

exec @ARGV;
exit 1;

sub turn_me_fifo {
	my ($gz_fn) = @_;

	return fork_to_gzip($gz_fn);
}

my %PIPES;
sub fork_to_gzip {
	my ($gz_fn) = @_;

	pipe my $read, my $write
		or die "cannot pipe: $!\n";

	for ($read, $write) {
		my $f = fcntl $_, F_GETFD, 0
			or die "cannot fcntl-get: $!\n";

		fcntl $_, F_SETFD, $f&~FD_CLOEXEC
			or die "cannot fcntl-unset FD_CLOEXEC: $!\n";

	my $pid = fork;
	die "cannot fork: $!\n" unless defined $pid;
	if ($pid) {
		$PIPES{$pid} = $read; # protect from gc
		return '/proc/self/fd/'.fileno($read);
	}

	open STDOUT, '>&', $write
		or die "cannot dup pipe to STDOUT: $!\n";

	exec qw/gzip -cd/, $gz_fn;
	exit 1;
}
